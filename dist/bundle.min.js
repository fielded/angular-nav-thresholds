!function(e){"use strict";function t(e,t){for(var o=0;o<e.length;o++)if(t(e[o]))return e[o]}function o(e){console&&console.warn("angular-nav-thresholds: "+e)}function r(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}e="default"in e?e.default:e;var a=[{version:1,date:"2016-01-01",coefficients:{"product:2-reconst-syg":{wastage:1.1,coverage:.87},"product:5-reconst-syg":{wastage:1.1,coverage:.87},"product:ad-syg":{wastage:1.05,coverage:.87},"product:bcg":{wastage:2,coverage:.9,doses:1},"product:bcg-syg":{coverage:.87},"product:diluent-bcg":{},"product:diluent-mv":{},"product:diluent-yf":{},"product:hep-b":{wastage:1.3333333333333333,coverage:.9,doses:1},"product:hpv":{wastage:1.1,coverage:.9,doses:2},"product:ipv":{wastage:1.05,coverage:.87,doses:1},"product:mv":{wastage:1.4285714285714286,coverage:.9,doses:1},"product:opv":{wastage:1.3333333333333333,coverage:.9,doses:4},"product:pcv":{wastage:1.05,coverage:.87,doses:3},"product:penta":{wastage:1.3333333333333333,coverage:.87,doses:3},"product:rota":{wastage:1.05,coverage:.87,doses:3},"product:safety-boxes":{wastage:1.05},"product:td":{wastage:1.3333333333333333,coverage:.87,doses:2},"product:yf":{wastage:1.4285714285714286,coverage:.9,doses:1}}},{version:2,date:"2017-01-01",coefficients:{"product:2-reconst-syg":{wastage:1.1,coverage:.87},"product:5-reconst-syg":{wastage:1.1,coverage:.87},"product:ad-syg":{wastage:1.05,coverage:.87},"product:bcg":{wastage:2,coverage:.94,doses:1},"product:bcg-syg":{coverage:.87},"product:diluent-bcg":{},"product:diluent-mv":{},"product:diluent-yf":{},"product:hep-b":{wastage:1.3333333333,coverage:.82,doses:1},"product:hpv":{wastage:1.1,coverage:.9,doses:2},"product:ipv":{wastage:1.25,coverage:.94,doses:1},"product:mv":{wastage:1.4285714285714286,coverage:.95,doses:1},"product:opv":{wastage:1.3333333333333333,coverage:.94,doses:4},"product:pcv":{wastage:1.0526315789,coverage:.94,doses:3},"product:penta":{wastage:1.3333333333333333,coverage:.94,doses:3},"product:rota":{wastage:1.05,coverage:.87,doses:3},"product:safety-boxes":{wastage:1.05},"product:td":{wastage:1.3333333333333333,coverage:.85,doses:2},"product:yf":{wastage:1.4285714285714286,coverage:.95,doses:1}}}],n={versions:a},s={versionDateFormat:"YYYY-MM-DD"},c={"product:bcg":"regular","product:mv":"regular","product:yf":"regular","product:opv":"regular","product:td":"regular","product:penta":"regular","product:hep-b":"regular","product:pcv":"regular","product:ipv":"regular","product:rota":"regular","product:hpv":"regular","product:ad-syg":"adSyg","product:bcg-syg":"bcg","product:5-reconst-syg":"fiveReconst","product:2-reconst-syg":"twoReconst","product:safety-boxes":"safetyBoxes","product:diluent-bcg":"diluentBcg","product:diluent-yf":"diluentYf","product:diluent-mv":"diluentMv"},i={};i.regular=function(e,t,o){return o*t.doses*t.coverage*t.wastage},i.adSyg=function(e){return e["product:penta"]+e["product:mv"]+e["product:yf"]+e["product:hep-b"]+e["product:td"]+e["product:pcv"]+e["product:ipv"]+e["product:hpv"]},i.bcg=function(e){return e["product:bcg"]},i.fiveReconst=function(e,t){return(e["product:mv"]+e["product:yf"])/10*t.wastage},i.twoReconst=function(e,t){return e["product:bcg"]/20*t.wastage},i.safetyBoxes=function(e,t){return(e["product:ad-syg"]+e["product:bcg-syg"]+e["product:5-reconst-syg"]+e["product:2-reconst-syg"])/100*t.wastage},i.diluentBcg=function(e){return e["product:bcg"]},i.diluentYf=function(e){return e["product:yf"]},i.diluentMv=function(e){return e["product:mv"]};var u=function(e,t,o,r){var a=t[r],n=e[r];return o[r]=0,void 0!==n&&a&&(o[r]=i[c[r]](o,a,n/4)),o},d=function(e,t){return Object.keys(c).reduce(u.bind(null,e,t),{})},g=function(e,t){var o=moment().isoWeekYear(e.year).isoWeek(e.week).isoWeekday(1).startOf("day"),r=moment(t.date,s.versionDateFormat).startOf("isoWeek").startOf("day");return o.isSameOrAfter(r)},l=function(e,o){var r=e.slice(0).reverse(),a=t(r,g.bind(null,o));return a?a:e[0]},p=function(e,t){if(!(e&&e.versions&&e.versions.length))throw new Error("missing productCoefficients or productCoefficients.versions");var o=l(e.versions,t);if(!o||!o.coefficients)throw new Error("cannot find version of coefficients for date "+t);return o.coefficients},v=function(e,t){if(!e.plans||!e.plans.length)throw new Error("missing plans on location "+e._id);var o=l(e.plans,t);if(!o||!o.weeksOfStock)throw new Error("cannot find version of weeksOfStock for location "+e._id+" and date "+t);return o.weeksOfStock},f=function(e,t){if(e.targetPopulations&&e.targetPopulations.length){var o=l(e.targetPopulations,t);return{version:o.version,monthlyTargetPopulations:o&&o.monthlyTargetPopulations}}return e.targetPopulation&&Object.keys(e.targetPopulation).length?{version:1,monthlyTargetPopulations:e.targetPopulation}:{version:1}},y=function(e,t){if(!e.allocations||!e.allocations.length)throw new Error("missing allocations on location "+e._id);var o=l(e.allocations,t);if(!o||!o.weeklyLevels)throw new Error("cannot find version of weeklyLevels for location "+e._id+" and date "+t);return o.weeklyLevels},w=function(e,t,o){var r=v(e,o),a=f(e,o),n=a.version,s=a.monthlyTargetPopulations;return 1===n?{weeklyLevels:y(e,o),weeksOfStock:r,monthlyTargetPopulations:s}:{weeklyLevels:d(s,p(t,o)),weeksOfStock:r,monthlyTargetPopulations:s}},h=function(){function e(e,t){for(var o=0;o<t.length;o++){var r=t[o];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}return function(t,o,r){return o&&e(t.prototype,o),r&&e(t,r),t}}(),m=function(){function e(t,o,a,n,s){r(this,e),this.$q=t,this.smartId=o,this.lgasService=a,this.statesService=n,this.locationsService=s}return h(e,[{key:"calculateThresholds",value:function(e,t,r){var a=arguments.length>3&&void 0!==arguments[3]?arguments[3]:{},s=arguments.length>4&&void 0!==arguments[4]?arguments[4]:n;if(!t){return o("missing mandatory param stock count for location "+(e&&e._id?e._id:"with unknown id"))}if(!t.date)return o("missing date on stock count "+t._id);if(!e){return o("missing mandatory param location for stock count "+(t&&t._id?t._id:"with unknown id"))}if(!e.level)return o("missing level on location "+e._id);if(!r||!r.length)return o("missing mandatory param products");var c=void 0;try{c=w(e,s,t.date)}catch(e){return void o(e.message)}var i=c,u=i.weeksOfStock,d=i.weeklyLevels,g=i.monthlyTargetPopulations;return r.reduce(function(t,o){var r=o._id,n=d[r],s=20;return o&&o.presentation&&(s=parseInt(o.presentation,10)),t[r]=Object.keys(u).reduce(function(t,o){var c=n*u[o],i=Math.ceil(c/s)*s;return t[o]=i,"zone"===e.level&&a[r]&&(t[o]+=a[r]),t},{}),t[r].weeklyLevel=n,g&&(t[r].targetPopulation=g[r]),t},{})}},{key:"getThresholdsFor",value:function(e,o){var r=this,a=arguments.length>2&&void 0!==arguments[2]?arguments[2]:n,s=function(e,t){return t._id===e},c={},i={};c=e.reduce(function(e,t){var o=t.location;if(!o)return e;var a=void 0;return o.national?(a="national",e[a]={date:t.date},e[a].type="national",i.national||(i.national=r.locationsService.get("national"))):(a=r.smartId.idify(o,"zone:?state:?lga"),e[a]={date:t.date},o.lga?(i.lga||(i.lga=r.lgasService.list()),e[a].type="lga"):o.state&&(i.state||(i.state=r.statesService.list()),e[a].type="state")),e},{});var u=function(e){return Object.keys(c).forEach(function(n){var i=c[n],u=void 0;u="national"===i.type?e[i.type]:t(e[i.type],s.bind(null,n)),i.thresholds=r.calculateThresholds(u,i,o,null,a),delete i.type}),c};return this.$q.all(i).then(u)}}]),e}();m.$inject=["$q","smartId","lgasService","statesService","locationsService"],e.module("angularNavThresholds",["angularNavData","ngSmartId"]).service("thresholdsService",m)}(angular);