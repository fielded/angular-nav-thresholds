!function(e){"use strict";function t(e,t){for(var r=0;r<e.length;r++)if(t(e[r]))return e[r]}function r(e){console&&console.warn("angular-nav-thresholds: "+e)}function o(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}e="default"in e?e.default:e;var a=[{version:1,date:"2016-01-01",coefficients:{"product:2-reconst-syg":{wastage:1.1,coverage:.87},"product:5-reconst-syg":{wastage:1.1,coverage:.87},"product:ad-syg":{wastage:1.05,coverage:.87},"product:bcg":{wastage:2,coverage:.9,doses:1},"product:bcg-syg":{coverage:.87},"product:diluent-bcg":{},"product:diluent-mv":{},"product:diluent-yf":{},"product:hep-b":{wastage:1.3333333333333333,coverage:.9,doses:1},"product:hpv":{wastage:1.1,coverage:.9,doses:2},"product:ipv":{wastage:1.05,coverage:.87,doses:1},"product:mv":{wastage:1.4285714285714286,coverage:.9,doses:1},"product:opv":{wastage:1.3333333333333333,coverage:.9,doses:4},"product:pcv":{wastage:1.05,coverage:.87,doses:3},"product:penta":{wastage:1.3333333333333333,coverage:.87,doses:3},"product:rota":{wastage:1.05,coverage:.87,doses:3},"product:safety-boxes":{wastage:1.05},"product:td":{wastage:1.3333333333333333,coverage:.87,doses:2},"product:yf":{wastage:1.4285714285714286,coverage:.9,doses:1}}},{version:2,date:"2017-01-01",coefficients:{"product:2-reconst-syg":{wastage:1.1,coverage:.87},"product:5-reconst-syg":{wastage:1.1,coverage:.87},"product:ad-syg":{wastage:1.05,coverage:.87},"product:bcg":{wastage:2,coverage:.94,doses:1},"product:bcg-syg":{coverage:.87},"product:diluent-bcg":{},"product:diluent-mv":{},"product:diluent-yf":{},"product:hep-b":{wastage:1.3333333333,coverage:.82,doses:1},"product:hpv":{wastage:1.1,coverage:.9,doses:2},"product:ipv":{wastage:1.25,coverage:.94,doses:1},"product:mv":{wastage:1.4285714285714286,coverage:.9,doses:1},"product:opv":{wastage:1.3333333333333333,coverage:.9,doses:4},"product:pcv":{wastage:1.0526315789,coverage:.94,doses:3},"product:penta":{wastage:1.3333333333333333,coverage:.87,doses:3},"product:rota":{wastage:1.05,coverage:.87,doses:3},"product:safety-boxes":{wastage:1.05},"product:td":{wastage:1.3333333333333333,coverage:.85,doses:2},"product:yf":{wastage:1.4285714285714286,coverage:.95,doses:1}}}],n={versions:a},s={versionDateFormat:"YYYY-MM-DD"},c={"product:bcg":"regular","product:mv":"regular","product:yf":"regular","product:opv":"regular","product:td":"regular","product:penta":"regular","product:hep-b":"regular","product:pcv":"regular","product:ipv":"regular","product:rota":"regular","product:hpv":"regular","product:ad-syg":"adSyg","product:bcg-syg":"bcg","product:5-reconst-syg":"fiveReconst","product:2-reconst-syg":"twoReconst","product:safety-boxes":"safetyBoxes","product:diluent-bcg":"diluentBcg","product:diluent-yf":"diluentYf","product:diluent-mv":"diluentMv"},u={};u.regular=function(e,t,r){return r*t.doses*t.coverage*t.wastage},u.adSyg=function(e){return e["product:penta"]+e["product:mv"]+e["product:yf"]+e["product:hep-b"]+e["product:td"]+e["product:pcv"]+e["product:ipv"]+e["product:hpv"]},u.bcg=function(e){return e["product:bcg"]},u.fiveReconst=function(e,t){return(e["product:mv"]+e["product:yf"])/10*t.wastage},u.twoReconst=function(e,t){return e["product:bcg"]/20*t.wastage},u.safetyBoxes=function(e,t){return(e["product:ad-syg"]+e["product:bcg-syg"]+e["product:5-reconst-syg"]+e["product:2-reconst-syg"])/100*t.wastage},u.diluentBcg=function(e){return e["product:bcg"]},u.diluentYf=function(e){return e["product:yf"]},u.diluentMv=function(e){return e["product:mv"]};var i=function(e,t,r,o){var a=t[o],n=e[o];return r[o]=0,void 0!==n&&a&&(r[o]=u[c[o]](r,a,n/4)),r},d=function(e,t){return Object.keys(c).reduce(i.bind(null,e,t),{})},g=function(e,t){var r=moment().isoWeekYear(e.year).isoWeek(e.week).isoWeekday(1).startOf("day"),o=moment(t.date,s.versionDateFormat).startOf("isoWeek").startOf("day");return r.isSameOrAfter(o)},l=function(e,r){var o=e.slice(0).reverse(),a=t(o,g.bind(null,r));return a?a:e[0]},p=function(e,t){if(!(e&&e.versions&&e.versions.length))throw new Error("missing productCoefficients or productCoefficients.versions");var r=l(e.versions,t);if(!r||!r.coefficients)throw new Error("cannot find version of coefficients for date "+t);return r.coefficients},v=function(e,t){if(!e.plans||!e.plans.length)throw new Error("missing plans on location "+e._id);var r=l(e.plans,t);if(!r||!r.weeksOfStock)throw new Error("cannot find version of weeksOfStock for location "+e._id+" and date "+t);return r.weeksOfStock},f=function(e,t){if(e.targetPopulations&&e.targetPopulations.length){var r=l(e.targetPopulations,t);return{version:r.version,monthlyTargetPopulations:r&&r.monthlyTargetPopulations}}return e.targetPopulation&&Object.keys(e.targetPopulation).length?{version:1,monthlyTargetPopulations:e.targetPopulation}:{version:1}},w=function(e,t){if(!e.allocations||!e.allocations.length)throw new Error("missing allocations on location "+e._id);var r=l(e.allocations,t);if(!r||!r.weeklyLevels)throw new Error("cannot find version of weeklyLevels for location "+e._id+" and date "+t);return r.weeklyLevels},y=function(e,t,r){var o=v(e,r),a=f(e,r),n=a.version,s=a.monthlyTargetPopulations;return 1===n?{weeklyLevels:w(e,r),weeksOfStock:o,monthlyTargetPopulations:s}:{weeklyLevels:d(s,p(t,r)),weeksOfStock:o,monthlyTargetPopulations:s}},h=function(){function e(e,t){for(var r=0;r<t.length;r++){var o=t[r];o.enumerable=o.enumerable||!1,o.configurable=!0,"value"in o&&(o.writable=!0),Object.defineProperty(e,o.key,o)}}return function(t,r,o){return r&&e(t.prototype,r),o&&e(t,o),t}}(),m=function(){function e(t,r,a,n){o(this,e),this.$q=t,this.smartId=r,this.lgasService=a,this.statesService=n}return h(e,[{key:"calculateThresholds",value:function(e,t,o){var a=arguments.length>3&&void 0!==arguments[3]?arguments[3]:{},s=arguments.length>4&&void 0!==arguments[4]?arguments[4]:n;if(!t){return r("missing mandatory param stock count for location "+(e&&e._id?e._id:"with unknown id"))}if(!t.date)return r("missing date on stock count "+t._id);if(!e){return r("missing mandatory param location for stock count "+(t&&t._id?t._id:"with unknown id"))}if(!e.level)return r("missing level on location "+e._id);if(!o||!o.length)return r("missing mandatory param products");var c=void 0;try{c=y(e,s,t.date)}catch(e){return void r(e.message)}var u=c,i=u.weeksOfStock,d=u.weeklyLevels,g=u.monthlyTargetPopulations;return o.reduce(function(t,r){var o=r._id,n=d[o],s=20;return r&&r.presentation&&(s=parseInt(r.presentation,10)),t[o]=Object.keys(i).reduce(function(t,r){var c=n*i[r],u=Math.ceil(c/s)*s;return t[r]=u,"zone"===e.level&&a[o]&&(t[r]+=a[o]),t},{}),t[o].weeklyLevel=n,g&&(t[o].targetPopulation=g[o]),t},{})}},{key:"getThresholdsFor",value:function(e,r){var o=this,a=arguments.length>2&&void 0!==arguments[2]?arguments[2]:n,s=function(e,t){return t._id===e},c={},u={};c=e.reduce(function(e,t){var r=t.location;if(!r)return e;var a=o.smartId.idify(r,"zone:?state:?lga");return e[a]={date:t.date},r.lga?(u.lga||(u.lga=o.lgasService.list()),e[a].type="lga"):r.state&&(u.state||(u.state=o.statesService.list()),e[a].type="state"),e},{});var i=function(e){return Object.keys(c).forEach(function(n){var u=c[n],i=t(e[u.type],s.bind(null,n));u.thresholds=o.calculateThresholds(i,u,r,null,a),delete u.type}),c};return this.$q.all(u).then(i)}}]),e}();m.$inject=["$q","smartId","lgasService","statesService"],e.module("angularNavThresholds",["angularNavData","ngSmartId"]).service("thresholdsService",m)}(angular);